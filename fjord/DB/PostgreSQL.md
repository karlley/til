# PostgreSQL

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹

* ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹: å¤§é‡ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã‚·ã‚¹ãƒ†ãƒ ä¸Šã§æ‰±ãˆã‚‹ã‚ˆã†ã«é›†ã‚ãŸã‚‚ã®
* ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ : ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’åŠ¹ç‡ã‚ˆãèª­ã¿æ›¸ãã™ã‚‹ãŸã‚ã®ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢
* DBMS: DataBase Management System

# PostgreSQL

> ãƒ•ãƒªãƒ¼ãªã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ã®ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒŠãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 

# ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒŠãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹

> ã‚ã‚‰ã‚†ã‚‹ãƒ‡ãƒ¼ã‚¿ã¯è¡¨ã§ã‚ã‚‰ã‚ã™  

* ãƒ†ãƒ¼ãƒ–ãƒ«: è¡¨ã€ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
* ã‚«ãƒ©ãƒ : ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç¸¦å‰²ã‚Šã—ãŸéƒ¨åˆ†ã€å±æ€§ã€åˆ—ã€åŒã˜è¡¨ã®ä¸­ã«åŒã˜åå‰ã®ã‚«ãƒ©ãƒ ã¯NG
* ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰: ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ¨ªå‰²ã‚Šã—ãŸéƒ¨åˆ†ã€ãƒ¬ã‚³ãƒ¼ãƒ‰ã€ã‚¿ãƒ—ãƒ«ã€è¡Œ

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ç‰¹å¾´

* 1ã¤ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å…¥ã‚Œã‚‹ã“ã¨ãŒã§ãã‚‹ãƒ‡ãƒ¼ã‚¿ã¯1ã¤
* ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®é€£çµ/åˆ†å‰²ã¯ã§ããªã„
* ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰(ãƒ¬ã‚³ãƒ¼ãƒ‰)ã®é †ç•ªã«ã¯æ„å‘³ã¯ç„¡ã„
* ãƒ‡ãƒ¼ã‚¿èª­å‡ºã—æ™‚ã«ãƒ‡ãƒ¼ã‚¿ã®é †ç•ªã‚’ä¸¦ã¹æ›¿ãˆã‚‹æ–¹æ³•ãŒã‚ã‚‹

# ãƒªã‚«ãƒãƒªã‚·ã‚¹ãƒ†ãƒ 

* ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ãƒªã‚«ãƒãƒª: ãƒ­ã‚°ã‚’ä½¿ã£ã¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æœ€æ–°ã®çŠ¶æ…‹ã«å¾©æ—§ã™ã‚‹
* ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒªã‚«ãƒãƒª: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¨ãƒ­ã‚°ã‚’ä¿å­˜ã—ã¦ãŠãã€ã“ã‚Œã‚‰ã‚’ä½¿ã£ã¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’å¾©å…ƒã™ã‚‹ã“ã¨

# ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³

* ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã¨ã£ã¦æ„å‘³ã®ã‚ã‚‹å‡¦ç†ã®å˜ä½ã§å‡¦ç†ã‚’é€²ã‚ã‚‹ã“ã¨
* å‡¦ç†ã®é€”ä¸­ã§ç•°å¸¸ãŒç™ºç”Ÿã—ãŸå ´åˆã¯å‡¦ç†ã®å˜ä½ã§ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã™ã‚‹
* è¤‡æ•°ã®å‡¦ç†ãŒä¸¦è¡Œã—ã¦è¡Œãªã‚ã‚Œã¦ã‚‚ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ãŒä¿ãŸã‚Œã‚‹

# Debian ã«PostgreSQL ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¯¾è±¡ã®Linux: Debian 11

[Debian 8\.7\(Jessie\)ã«PostgreSQL 9\.6ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã€å¤–éƒ¨æ¥ç¶šã‚’è¨±å¯ã™ã‚‹ \- Symfoware](https://symfoware.blog.fc2.com/blog-entry-1948.html)

ä¸Šè¨˜URL ã‚’å‚è€ƒã«ã—ã¦ãƒªãƒã‚¸ãƒˆãƒªã®è¿½åŠ ã€èªè¨¼ã‚­ãƒ¼è¿½åŠ å¾Œã«ä¸‹è¨˜ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚³ãƒãƒ³ãƒ‰ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ããªã‹ã£ãŸ

```
# apt-get install postgresql-9.6
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
E: Unable to locate package postgresql-9.6
E: Couldn't find any package by glob 'postgresql-9.6'
E: Couldn't find any package by regex 'postgresql-9.6'
```

ãƒãƒ¼ã‚¸ãƒ§ãƒ³æŒ‡å®šç„¡ã—ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã¨ã“ã‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ããŸ

```
# apt-get install postgresql
...
# su - postgres
~$ psql
psql (13.5 (Debian 13.5-0+deb11u1))
Type "help" for help.

postgres=#
```

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’ç¢ºèª

```
$ apt list --installed | grep postgresql

WARNING: apt does not have a stable CLI interface. Use with caution in scripts.

postgresql-13/stable,stable-security,now 13.5-0+deb11u1 amd64 [installed,automatic]
postgresql-client-13/stable,stable-security,now 13.5-0+deb11u1 amd64 [installed,automatic]
postgresql-client-common/stable,now 225 all [installed,automatic]
postgresql-common/stable,now 225 all [installed,automatic]
postgresql/stable,now 13+225 all [installed]

$ psql --version
psql (PostgreSQL) 13.5 (Debian 13.5-0+deb11u1)
```

# `su - postgres` ã®`-` ã«ã¤ã„ã¦

`su` ã‚³ãƒãƒ³ãƒ‰ã®`-` ã®æœ‰ç„¡ã§å‹•ä½œãŒç•°ãªã‚‹

* `-` æœ‰ã‚Š: ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã€ç’°å¢ƒå¤‰æ•°ãŒãŒåˆæœŸåŒ–
* `-` ç„¡ã—: ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œå‰ã®ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã€ç’°å¢ƒå¤‰æ•°ã‚’å¼•ãç¶™ãç®¡ç†è€…æ¨©é™ã§ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹

# DB ã«æ¥ç¶šã™ã‚‹ã¾ã§ã®æµã‚Œ

[postgresã¨ã—ã¦ã€ãƒ­ã‚°ã‚¤ãƒ³ã§ããªã„ã§ã™](https://teratail.com/questions/243773)

* PostgreSQL ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§`postgres` ã¨ã„ã†åå‰ã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã€ãƒ­ãƒ¼ãƒ«ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹
* `CREATE ROLE` ã§ãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆã§ãã‚‹
* ä½œæˆã—ãŸãƒ­ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã™ã‚Œã°èª°ã§ã‚‚DBã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹
* ãƒ­ãƒ¼ãƒ«ã¯å„DBã«å¯¾ã—ã¦æ“ä½œã§ãã‚‹ãƒ¦ãƒ¼ã‚¶ã¿ãŸã„ãªã‚‚ã®
* `-U` ã‚’çœç•¥ã™ã‚‹ã¨ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶åã¨åŒåã®ãƒ­ãƒ¼ãƒ«ã§DBã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹
* å¼•æ•°ç„¡ã—ã§`psql` ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ãŸå ´åˆã¯ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ã¨åŒåã®ãƒ­ãƒ¼ãƒ«ã€DBã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹
* ãƒ­ãƒ¼ãƒ«åã€DBåã‚’æŒ‡å®šã—ã¦ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å ´åˆã¯`psql -U ãƒ­ãƒ¼ãƒ«å DBå`

postgres ãƒ­ãƒ¼ãƒ«ã§DB ã«æ¥ç¶šã™ã‚‹æµã‚Œ

1. root ãƒ¦ãƒ¼ã‚¶ã«åˆ‡ã‚Šæ›¿ãˆ
2. postgres ãƒ¦ãƒ¼ã‚¶ã«åˆ‡ã‚Šæ›¿ãˆ
3. `psql` ã‚³ãƒãƒ³ãƒ‰ã§DBã«ã‚¢ã‚¯ã‚»ã‚¹

```
# root ãƒ¦ãƒ¼ã‚¶ã«åˆ‡ã‚Šæ›¿ãˆ
$ su

# root ãƒ¦ãƒ¼ã‚¶ ã‹ã‚‰postgres ãƒ¦ãƒ¼ã‚¶ã«åˆ‡ã‚Šæ›¿ãˆ
root@...# su - postgres

# postgres ãƒ¦ãƒ¼ã‚¶ã§postgres ãƒ­ãƒ¼ãƒ«ã§postgres DB ã«æ¥ç¶š
postgres@...# psql -U postgres

# -U ã‚’çœç•¥ã™ã‚‹ã¨ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ã¨åŒåã®ãƒ­ãƒ¼ãƒ«ã§postgres ã¨ã„ã†åå‰ã®DBã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹(ã“ã®å ´åˆã ã¨postgres ãƒ­ãƒ¼ãƒ«)
postgres@...# psql postgres

# å¼•æ•°ç„¡ã—ã ã¨ãƒ¦ãƒ¼ã‚¶åã¨åŒåã®ãƒ­ãƒ¼ãƒ«ã€DBã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹
postgres@...# psql

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ä½œæˆã•ã‚Œã‚‹DBã€ãƒ­ãƒ¼ãƒ«ã‚’ç¢ºèª(postgres DBã€postgres ãƒ­ãƒ¼ãƒ« ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹)
postgres=# \l
                                  List of databases
   Name    |  Owner   | Encoding |   Collate   |    Ctype    |   Access privileges
-----------+----------+----------+-------------+-------------+-----------------------
 postgres  | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 |
 template0 | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres          +
           |          |          |             |             | postgres=CTc/postgres
 template1 | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres          +
           |          |          |             |             | postgres=CTc/postgres
(3 rows)

postgres=# \du
                                   List of roles
 Role name |                         Attributes                         | Member of
-----------+------------------------------------------------------------+-----------
 postgres  | Superuser, Create role, Create DB, Replication, Bypass RLS | {}
```

# PostgreSQL ã‚’Debian ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

å‚è€ƒURLã§ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã®æ‰‹é †ãŒã„ã¾ã„ã¡ç†è§£ã§ããªã‹ã£ãŸã®ã§ã€å…¬å¼ã‚’å‚è€ƒã«å†åº¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

1. ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å…ˆã®Debian ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª

å‚ç…§: [Linuxã«PostgreSQLã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹éš›ã®ã‚¨ãƒ©ãƒ¼ã®è§£æ±ºç­– \| FJORD BOOT CAMPï¼ˆãƒ•ã‚£ãƒ¨ãƒ«ãƒ‰ãƒ–ãƒ¼ãƒˆã‚­ãƒ£ãƒ³ãƒ—ï¼‰](https://bootcamp.fjord.jp/questions/769)

```
# Debian ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
$ cat /etc/debian_version
11.3
```

2. [PostgreSQLã®å…¬å¼](https://www.postgresql.org/download/linux/debian/) ã§Debian ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒå¯¾å¿œã—ã¦ã„ã‚‹ã‹ç¢ºèª(ã•ãã‚‰VPSã®ã‚«ã‚¹ã‚¿ãƒ OSã¯`Debian 11 amd64`ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿)

3. ãƒªãƒã‚¸ãƒˆãƒªè¿½åŠ ã€å…¬é–‹éµè¿½åŠ 

```
# ãƒªãƒã‚¸ãƒˆãƒªã‚’è¿½åŠ 
$ sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'

# ãƒªãƒã‚¸ãƒˆãƒªã®è¿½åŠ ã‚’ç¢ºèª
$ cat /etc/apt/sources.list.d/pgdg.list
deb http://apt.postgresql.org/pub/repos/apt bullseye-pgdg main
```

4. å…¬é–‹éµã®è¿½åŠ ã§`gnupg`ã€`gnupg2`ã©ã¡ã‚‰ã‹ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’æ±‚ã‚ã‚‰ã‚Œã‚‹å ´åˆã¯è¿½åŠ ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¾Œã€å†åº¦å…¬é–‹éµã‚’è¿½åŠ 

å‚ç…§: [ã€ğŸ¹ \| FJORD BOOT CAMPï¼ˆãƒ•ã‚£ãƒ¨ãƒ«ãƒ‰ãƒ–ãƒ¼ãƒˆã‚­ãƒ£ãƒ³ãƒ—ï¼‰](https://bootcamp.fjord.jp/reports/38699)

```
# å…¬é–‹éµã‚’è¿½åŠ 
$ wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
E: gnupg, gnupg2 and gnupg1 do not seem to be installed, but one of them is required for this operation # ã‚ˆãåˆ†ã‹ã‚‰ãªã„

# å…¬é–‹éµã‚’è¿½åŠ ã§gnupg/gnupg2 ã©ã¡ã‚‰ã‹ã®ãƒ„ãƒ¼ãƒ«ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’æ±‚ã‚ã‚‰ã‚ŒãŸã®ã§è¿½åŠ 
$ sudo apt install gnupg

# gnupg ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’ç¢ºèª
$ apt list --installed | grep gnupg

WARNING: apt does not have a stable CLI interface. Use with caution in scripts.

gnupg-l10n/stable,now 2.2.27-2+deb11u1 all [installed,automatic]
gnupg-utils/stable,now 2.2.27-2+deb11u1 amd64 [installed,automatic]
gnupg/stable,now 2.2.27-2+deb11u1 all [installed]

# å†åº¦ã€å…¬é–‹éµã‚’è¿½åŠ 
$ wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
Warning: apt-key is deprecated. Manage keyring files in trusted.gpg.d instead (see apt-key(8)).
OK
```

5. PostgreSQL ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« 

```
# ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æ›´æ–°
$ sudo apt-get update

# ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
$ sudo apt-get -y install postgresql

# ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç¢ºèª
$ apt list --installed | grep postgresql

WARNING: apt does not have a stable CLI interface. Use with caution in scripts.

postgresql-14/bullseye-pgdg,now 14.2-1.pgdg110+1 amd64 [installed,automatic]
postgresql-client-14/bullseye-pgdg,now 14.2-1.pgdg110+1 amd64 [installed,automatic]
postgresql-client-common/bullseye-pgdg,now 238.pgdg110+1 all [installed,automatic]
postgresql-common/bullseye-pgdg,now 238.pgdg110+1 all [installed,automatic]
postgresql/bullseye-pgdg,now 14+238.pgdg110+1 all [installed]

$ psql --version
psql (PostgreSQL) 14.2 (Debian 14.2-1.pgdg110+1)
```

6. psql èµ·å‹•

```
# ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ä½œæˆã•ã‚Œï½”ã‚‰postgres ãƒ¦ãƒ¼ã‚¶ã«åˆ‡æ›¿
$ sudo su - postgresql

# postgres ãƒ¦ãƒ¼ã‚¶ã§psql ã‚’èµ·å‹•
postgres@...$ psql
psql (14.2 (Debian 14.2-1.pgdg110+1))
Type "help" for help.

postgres=#
```

# PostgreSQL ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å¤‰æ›´ã—ãŸã‚‰psql ãŒèµ·å‹•ã—ãªããªã£ãŸ

PostgreSQL ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å¤‰æ›´ã—ãŸéš›ã«ä¸‹è¨˜ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ

åŸå› : æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ä¸è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ãŒæ®‹ã£ã¦ã„ãŸ

```
# postgres ãƒ¦ãƒ¼ã‚¶ã«åˆ‡æ›¿
$ sudo su - postgresql

# æ¥ç¶š
postgres@...$ psql
psql: error: connection to server on socket "/var/run/postgresql/.s.PGSQL.5432" failed: No such file or directory
	Is the server running locally and accepting connections on that socket?
```

psql ã‚µãƒ¼ãƒã®èµ·å‹•ç¢ºèª

* æ­£å¸¸: Status ãŒ`online`
* ç•°å¸¸: Status ãŒ`down`

```
# å‰Šé™¤ã—ãŸã¯ãšã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³13ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹
$ pg_lsclusters
Ver Cluster Port Status                Owner     Data directory              Log file
13  main    5432 down,binaries_missing <unknown> /var/lib/postgresql/13/main /var/log/postgresql/postgresql-13-main.log
14  main    5433 online                postgres  /var/lib/postgresql/14/main /var/log/postgresql/postgresql-14-main.log
```

ä¸è¦ãªãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å‰Šé™¤

```
$ sudo rm -rf /etc/postgresql/13/
```

psql ã‚µãƒ¼ãƒå†èµ·å‹•

```
$ sudo service postgresql restart
```

å†åº¦ã€psqlã‚µãƒ¼ãƒã®èµ·å‹•ç¢ºèª

```
# æ­£å¸¸ã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³14ã®ã¿ãŒèµ·å‹•ã—ã¦ã„ã‚‹
$ pg_lsclusters
Ver Cluster Port Status Owner    Data directory              Log file
14  main    5433 online postgres /var/lib/postgresql/14/main /var/log/postgresql/postgresql-14-main.log
```

psql ã«æ¥ç¶š

```
# postgres ãƒ¦ãƒ¼ã‚¶ã«åˆ‡æ›¿
$ sudo su - postgres

# æ¥ç¶š
postgres@...$ psql
psql (14.2 (Debian 14.2-1.pgdg110+1))
Type "help" for help.

postgres=#
```

[Debianã«PostgreSQLã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸå¾Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã§ããª \| FJORD BOOT CAMPï¼ˆãƒ•ã‚£ãƒ¨ãƒ«ãƒ‰ãƒ–ãƒ¼ãƒˆã‚­ãƒ£ãƒ³ãƒ—ï¼‰](https://bootcamp.fjord.jp/questions/985)

[Postgresqlã«æ¥ç¶šã§ããªã„æ™‚ã®å¯¾å‡¦æ³• \- Qiita](https://qiita.com/Dexctersu/items/3d6bc50bf1d4a294980b)

[PostgreSQL ã§ psql ã‚³ãƒãƒ³ãƒ‰ ã‚’å®Ÿè¡Œã—ãŸã‚‰ could not connect to database postgres: could not connect to server: No such file or directory ã¨å‡ºã‚‹å ´åˆ \- ç´„æŸã®åœ°](https://obel.hatenablog.jp/entry/20181027/1540588239)

[service postgresql status](https://femoghalvfems.info/archives/20776)

# PostgreSQL ã®ã‚¢ãƒ³ã‚¹ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ã®æ³¨æ„ç‚¹

[Ubuntuã§Postgresql ã®å‰Šé™¤ \- Qiita](https://qiita.com/ho_soft/items/5136bc0dcee2ca110d8a)

[dpkg \-l \| grep postgres](https://postgresweb.com/uninstall-postgresql-ubuntu2004)

ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ™‚ã«ã¯è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚‚å«ã‚ã¦å‰Šé™¤ã™ã‚‹

1. å‰Šé™¤å¯¾è±¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢
2. ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚‚å«ã‚ã¦remove ã™ã‚‹
3. å‰Šé™¤å¯¾è±¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå‰Šé™¤ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

```
# å‰Šé™¤å¯¾è±¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢
$ dpkg -l | grep postgresql
ãƒ•ã‚¡ã‚¤ãƒ«å

# remove
$ sudo apt remove --purge ãƒ•ã‚¡ã‚¤ãƒ«å

# å‰Šé™¤ã•ã‚ŒãŸã‹ç¢ºèª
$ dpkg -l | grep postgresql
```

# apt ã®å‰Šé™¤ã‚³ãƒãƒ³ãƒ‰ã®é•ã„

[apt\-get ã®purgeã¨removeã«ã¤ã„ã¦](https://teratail.com/questions/119697)

* `apt remove`: ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’å‰Šé™¤ã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¯å‰Šé™¤ã—ãªã„(å†åº¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã¨è¨­å®šãŒå¼•ç¶™ãŒã‚Œã‚‹)
* `apt purge`: ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
* `apt remove --purge`: `apt purge` ã¨åŒã˜
* `apt autoremove`: ä¾å­˜é–¢ä¿‚ã®ç„¡ã„ä¸è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’è‡ªå‹•å‰Šé™¤

# å¤–éƒ¨æ¥ç¶šè¨­å®š

å¤–éƒ¨æ¥ç¶šã®è¨­å®šã‚’ä¸‹è¨˜ã®2ã¤ã«è¿½åŠ 

* `/etc/postgresql/14/main/postgresql.conf`: listen ã™ã‚‹IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¨­å®š
* `/etc/postgresql/14/main/pg_hba.conf`: æ¥ç¶šã‚’è¨±å¯ã™ã‚‹IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¨­å®š

## postgresql.conf

å…¨IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã‚‰listen ã™ã‚‹è¨­å®šã‚’è¿½åŠ 

* `*` ã§å…¨ã¦ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯
* å¤‰æ›´ã§ã¯ç„¡ãè¿½è¨˜ã™ã‚‹ã“ã¨

```
$ sudo vim /etc/postgresql/14/main/postgresql.conf
```

```
# /etc/postgresql/14/main/postgresql.conf

#listen_addresses = 'localhost'         # what IP address(es) to listen on;
listen_addresses = '*' # è¿½è¨˜
```

ã¡ãªã¿ã«ãƒãƒ¼ãƒˆã®è¨­å®šã¯å¤‰æ›´ã—ãªãã¦ok

* ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã•ã‚Œã¦ã„ã‚‹çŠ¶æ…‹ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®`5432` ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹
* ãƒãƒ¼ãƒˆã‚’å¤‰æ›´ã™ã‚‹å ´åˆã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã‚’å¤–ã—ã¦ãƒãƒ¼ãƒˆç•ªå·ã‚’æŒ‡å®šã™ã‚‹

```
# /etc/postgresql/14/main/postgresql.conf

#port = 5432                             # (change requires restart)
```

## pg_hba.conf 

ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹mac ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’èª¿ã¹ã‚‹

* `ipconfig` ã§è¡¨ç¤ºã•ã‚Œã‚‹IPã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ãƒ­ãƒ¼ã‚«ãƒ«IPã‚¢ãƒ‰ãƒ¬ã‚¹ãªã®ã§è¨­å®šã—ãªã„ã“ã¨
* sshã§æ¥ç¶šã—ã¦ã„ãªã„çŠ¶æ…‹ã§è¡Œã†(ãƒ­ãƒ¼ã‚«ãƒ«ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§å®Ÿè¡Œ)

```
# ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹macã®IPã‚¢ãƒ‰ãƒ¬ã‚¹
$ curl inet-ip.info
xxx.xxx.xxx.xxx
```

macã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã‚‰ã®æ¥ç¶šã‚’è¨±å¯ã™ã‚‹

* ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å´ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŒ‡å®šã™ã‚‹ 
* ãƒãƒ¼ãƒˆç•ªå·ã¯`0`
* å…¨ã¦ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã‚‰ã®æ¥ç¶šã‚’è¨±å¯ã™ã‚‹å ´åˆã¯`0.0.0.0/0` ã‚’æŒ‡å®šã™ã‚‹

```
$ sudo vim /etc/postgresql/14/main/pg_hba.conf
```

```
# /etc/postgresql/14/main/pg_hba.conf 

# IPv4 local connections:
host    all             all             127.0.0.1/32            scram-sha-256
host    all             all             xxx.xxx.xxx.xxx/0       scram-sha-256 # è¿½è¨˜
```

PostgreSQL ã‚’å†èµ·å‹•

```
$ sudo service postgresql restart
```

# å¤–éƒ¨æ¥ç¶šã‚’ç¢ºèª

ssh ã§æ¥ç¶šã—ã¦ã„ãªã„çŠ¶æ…‹ã§ã•ãã‚‰VPSã®PostgreSQL ã«ã‚¢ã‚¯ã‚»ã‚¹

```
# ãƒ›ã‚¹ãƒˆåã§ã‚¢ã‚¯ã‚»ã‚¹
$ psql -U karlley -d postgres -h ik1-215-78392.vs.sakura.ne.jp
Password for user karlley: #å¤–éƒ¨æ¥ç¶šç”¨ãƒ­ãƒ¼ãƒ«ã§è¨­å®šã—ãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
psql (14.2)
SSL connection (protocol: TLSv1.3, cipher: TLS_AES_256_GCM_SHA384, bits: 256, compression: off)
Type "help" for help.

# IPã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒãƒ¼ãƒˆç•ªå·ã§ã‚¢ã‚¯ã‚»ã‚¹
$ psql -U karlley -d postgres -h 153.120.41.146 -p 5432
```

# 192.168.x.x ã¨ã¯

[ãªãœã€Œ192\.168\.x\.xã€ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä½¿ã†ï¼Ÿ \| æ—¥çµŒã‚¯ãƒ­ã‚¹ãƒ†ãƒƒã‚¯ï¼ˆxTECHï¼‰](https://xtech.nikkei.com/it/free/NNW/NETHOT/20040624/146335/)

[ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆIPã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ã¯](https://www.pc-master.jp/internet/private-ip-address.html)

* `192.168.x.x` ã¯ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ»ã‚¢ãƒ‰ãƒ¬ã‚¹
* ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ»ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å‰²ã‚Šå½“ã¦ãŸã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãŒé–“é•ã£ã¦ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã«ã¤ãªãŒã£ã¦ã‚‚ä½•ã‚‚èµ·ã“ã‚‰ãªã„
* ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ»ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ãƒ›ã‚¹ãƒˆã¯ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆä¸Šã«å­˜åœ¨ã—ãªã„
* ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆIPã‚¢ãƒ‰ãƒ¬ã‚¹ == ãƒ­ãƒ¼ã‚«ãƒ«IPã‚¢ãƒ‰ãƒ¬ã‚¹
* ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆIPã‚¢ãƒ‰ãƒ¬ã‚¹ã®ç¨®é¡
	* `10.0.x.x`: ã‚¯ãƒ©ã‚¹Aã€å¤§è¦æ¨¡ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å‘ã‘
	* `172.16.x.x`: ã‚¯ãƒ©ã‚¹Bã€ä¸­è¦æ¨¡ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å‘ã‘
	* `192.168.x.x`: ã‚¯ãƒ©ã‚¹Cã€å°è¦æ¨¡ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å‘ã‘ã€ãƒ«ãƒ¼ã‚¿ã‚„PCã§å‰²å½“ã‚‰ã‚Œã‚‹

# ã‚µãƒ–ãƒãƒƒãƒˆãƒã‚¹ã‚¯

[ã‚µãƒ–ãƒãƒƒãƒˆãƒã‚¹ã‚¯ \(subnet mask\)ã¨ã¯ï½œã€Œåˆ†ã‹ã‚Šãã†ã€ã§ã€Œåˆ†ã‹ã‚‰ãªã„ã€ã§ã‚‚ã€Œåˆ†ã‹ã£ãŸã€æ°—ã«ãªã‚Œã‚‹ITç”¨èªè¾å…¸](https://wa3.i-3-i.info/word11975.html)

> IPã‚¢ãƒ‰ãƒ¬ã‚¹ã®ã©ã“ã‹ã‚‰ã©ã“ã¾ã§ãŒã€Œã©ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã§ã™ã‚ˆï½ã€ãªæƒ…å ±ã§ã€ã©ã“ã‹ã‚‰ã©ã“ã¾ã§ãŒã€Œã©ã®ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã§ã™ã‚ˆï½ã€ãªæƒ…å ±ã‹ã‚’ç¤ºã™æƒ…å ±

`192.168.1.11` ã‚’ä¾‹ã«ã™ã‚‹

* ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯éƒ¨: `192.168.1` ã¾ã§
* ãƒ›ã‚¹ãƒˆéƒ¨: `11`ã€å„PCã‚„æ©Ÿå™¨ã«å‰²å½“ã‚‰ã‚Œã‚‹
* ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯éƒ¨ã€ãƒ›ã‚¹ãƒˆéƒ¨ã‚’çµ„ã¿åˆã‚ã›ã‚‹ãƒ«ãƒ¼ãƒ«ã‚’ã‚µãƒ–ãƒãƒƒãƒˆãƒã‚¹ã‚¯ã¨å‘¼ã¶
* ã‚µãƒ–ãƒãƒƒãƒˆãƒã‚¹ã‚¯ã¯å¤§è¦æ¨¡ã€ä¸­è¦æ¨¡ã®ã¿ã§å¤‰æ›´ã™ã‚‹å ´åˆãŒæ®†ã©

# 127.0.0.1 ã¨ã¯

[127\.0\.0\.1ã¨ã¯ï½œã€Œåˆ†ã‹ã‚Šãã†ã€ã§ã€Œåˆ†ã‹ã‚‰ãªã„ã€ã§ã‚‚ã€Œåˆ†ã‹ã£ãŸã€æ°—ã«ãªã‚Œã‚‹ITç”¨èªè¾å…¸](https://wa3.i-3-i.info/word17065.html)

[127\.0\.0\.1ã¨localhostã¨0\.0\.0\.0ã®é•ã„ \- Qiita](https://qiita.com/1ain2/items/194a9372798eaef6c5ab)

* è‡ªåˆ†ã®ä»Šä½¿ã£ã¦ã„ã‚‹ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹
* ãƒ«ãƒ¼ãƒ—ãƒãƒƒã‚¯ã‚¢ãƒ‰ãƒ¬ã‚¹
* åŒä¸€ãƒ›ã‚¹ãƒˆå†…ã§ã—ã‹é€šä¿¡ã‚’è¡Œãªã‚ãªã„
* `localhost` ã¨åŒæ„ç¾©
* `0.0.0.0` ã¨ã¯ç•°ãªã‚‹(å…¨ã¦ã®é€šä¿¡ã‚’è¡¨ã™ã€ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ã®ã‚ˆã†ãªã‚‚ã®)

# pg_hba.conf ã«è¨­å®šã™ã‚‹èªè¨¼æ–¹å¼ã®ç¨®é¡

èªè¨¼æ–¹å¼ã«ã¯ã„ãã¤ã‹ç¨®é¡ãŒã‚ã‚‹

* `scram-sha-256`: ç¾åœ¨æä¾›ã•ã‚Œã¦ã„ã‚‹ä¸­ã§ã¯æœ€ã‚‚å®‰å…¨
* `md5`: å®‰å…¨æ€§ã¯ä½ã„
* `peer`: OSã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å–å¾—ã—ã¦DBã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦ä½¿ã†èªè¨¼æ–¹å¼

# ãƒ­ãƒ¼ãƒ«ã®ä½œæˆ/å‰Šé™¤

OSã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ­ãƒ¼ãƒ«ã®ä½œæˆ/å‰Šé™¤ã‚’è¡Œã†

* ä½œæˆ: `createuser`
* å‰Šé™¤: `dropuser`

```
# ãƒ­ãƒ¼ãƒ«ä½œæˆ
$ createuser --pwprompt --interactive hoge
Enter password for new role: # ãƒ­ãƒ¼ãƒ«ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
Enter it again: # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å†å…¥åŠ›
Shall the new role be a superuser? (y/n) y # ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ¦ãƒ¼ã‚¶ã«è¨­å®š

# æ¥ç¶šç¢ºèª
$ psql -U hoge -d postgres
Password for user hoge:
psql (14.2 (Debian 14.2-1.pgdg110+1))
Type "help" for help.

postgres=#

# ãƒ­ãƒ¼ãƒ«ã®ä½œæˆã‚’ç¢ºèª
postgres=# \du
                                   List of roles
 Role name |                         Attributes                         | Member of
-----------+------------------------------------------------------------+-----------
 hoge      | Superuser, Create role, Create DB                          | {}
 karlley   | Superuser, Create role, Create DB                          | {}
 postgres  | Superuser, Create role, Create DB, Replication, Bypass RLS | {}
```

```
# ãƒ­ãƒ¼ãƒ«å‰Šé™¤
$ dropuser hoge
Password: # ç®¡ç†è€…ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰

# ãƒ­ãƒ¼ãƒ«ã®å‰Šé™¤ã‚’ç¢ºèª
$ psql -U karlley -d postgres
Password for user karlley:
psql (14.2 (Debian 14.2-1.pgdg110+1))
Type "help" for help.

postgres=# \du
                                   List of roles
 Role name |                         Attributes                         | Member of
-----------+------------------------------------------------------------+-----------
 karlley   | Superuser, Create role, Create DB                          | {}
 postgres  | Superuser, Create role, Create DB, Replication, Bypass RLS | {}
```

psql ã‚’ç«‹ã¡ä¸Šã’ãŸçŠ¶æ…‹ã§SQLã§ãƒ­ãƒ¼ãƒ«ã®ä½œæˆ/å‰Šé™¤ã‚’è¡Œã†å ´åˆã¯ä¸‹è¨˜ã®SQLæ–‡ã‚’ä½¿ç”¨ã™ã‚‹

* ä½œæˆ: `CREATE USER`
* å‰Šé™¤: `DROP USER`

# ä½œæˆã—ãŸãƒ­ãƒ¼ãƒ«ã§ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«èªè¨¼ã‚­ãƒ¼ã§ã‚¨ãƒ©ãƒ¼

ãƒ­ãƒ¼ãƒ«`hoge` ã§DB `postgres` ã«æ¥ç¶š

```
$ psql -U hoge -d postgres
psql: error: connection to server on socket "/var/run/postgresql/.s.PGSQL.5432" failed: FATAL:  Peer authentication failed for user "hoge"
```

* ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®èªè¨¼`Peer` ã§ã‚¨ãƒ©ãƒ¼
* ä»Šå›è¨­å®šã—ãŸèªè¨¼æ–¹å¼ã¯`Peer` ã§ã¯ãªã`scram-sha-256` ã‚’ä½¿ã£ã¦ã„ã‚‹

`/etc/postgresql/14/main/pg_hba.conf` ã®ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®èªè¨¼æ–¹å¼ã‚’ä¿®æ­£

```
$ sudo vim /etc/postgresql/14/main/pg_hba.conf
```

```
# /etc/postgresql/14/main/pg_hba.conf

# "local" is for Unix domain socket connections only
#local    all             all                        peer # ã“ã“ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã‹å‰Šé™¤ã™ã‚‹
local    all             all                        scram-sha-256 # è¿½è¨˜
```

å†èµ·å‹•

```
$ sudo service postgresql restart
```

æ¥ç¶šã§ãã‚‹ã‚ˆã†ã«ãªã‚‹

```
$ psql -U hoge -d postgres
Password for user hoge:
psql (14.2 (Debian 14.2-1.pgdg110+1))
Type "help" for help.

postgres=#
```